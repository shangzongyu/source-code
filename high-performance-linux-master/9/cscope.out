cscope 15 $HOME/high-performance-linux/9 -q 0000000165 0000020828
	@9-1use_select.cpp

1 
	~<sys/ty³s.h
>

2 
	~<sys/sock‘.h
>

3 
	~<Ãtš‘/š.h
>

4 
	~<¬·/š‘.h
>

5 
	~<as£¹.h
>

6 
	~<¡dio.h
>

7 
	~<uni¡d.h
>

8 
	~<”ºo.h
>

9 
	~<¡ršg.h
>

10 
	~<fú.h
>

11 
	~<¡dlib.h
>

13 
	$maš
Ğ
¬gc
, * 
¬gv
[] )

15 ifĞ
¬gc
 <= 2 )

17 
	`´štf
Ğ"u§ge: % _add»s pÜt_numb”\n", 
	`ba£Çme
Ğ
¬gv
[0] ) );

20 cÚ¡ * 

 = 
¬gv
[1];

21 
pÜt
 = 
	`©oi
Ğ
¬gv
[2] );

22 
	`´štf
Ğ" i % ªd…Üˆi %d\n", 

, 
pÜt
 );

24 
»t
 = 0;

25 
sockaddr_š
 
add»ss
;

26 
	`bz”o
Ğ&
add»ss
, (‡ddress ) );

27 
add»ss
.
sš_çmy
 = 
AF_INET
;

28 
	`š‘_±Ú
Ğ
AF_INET
, 

, &
add»ss
.
sš_addr
 );

29 
add»ss
.
sš_pÜt
 = 
	`htÚs
Ğ
pÜt
 );

31 
li¡’fd
 = 
	`sock‘
Ğ
PF_INET
, 
SOCK_STREAM
, 0 );

32 
	`as£¹
Ğ
li¡’fd
 >= 0 );

34 
»t
 = 
	`bšd
Ğ
li¡’fd
, ( 
sockaddr
* )&
add»ss
, (‡ddress ) );

35 
	`as£¹
Ğ
»t
 != -1 );

37 
»t
 = 
	`li¡’
Ğ
li¡’fd
, 5 );

38 
	`as£¹
Ğ
»t
 != -1 );

40 
sockaddr_š
 
ş›Á_add»ss
;

41 
sockËn_t
 
ş›Á_add¾’gth
 = Ğ
ş›Á_add»ss
 );

42 
cÚnfd
 = 
	`acû±
Ğ
li¡’fd
, ( 
sockaddr
* )&
ş›Á_add»ss
, &
ş›Á_add¾’gth
 );

43 iàĞ
cÚnfd
 < 0 )

45 
	`´štf
Ğ"”ºØis: %d\n", 
”ºo
 );

46 
	`şo£
Ğ
li¡’fd
 );

49 
»mÙe_addr
[
INET_ADDRSTRLEN
];

50 
	`´štf
Ğ"cÚÃùed w™h ip: % ªd…Üt: %d\n", 
	`š‘_Áİ
Ğ
AF_INET
, &
ş›Á_add»ss
.
sš_addr
, 
»mÙe_addr
, 
INET_ADDRSTRLEN
 ), 
	`Áohs
Ğş›Á_add»ss.
sš_pÜt
 ) );

52 
buf
[1024];

53 
fd_£t
 
»ad_fds
;

54 
fd_£t
 
exû±iÚ_fds
;

56 
	`FD_ZERO
Ğ&
»ad_fds
 );

57 
	`FD_ZERO
Ğ&
exû±iÚ_fds
 );

59 
nReu£Addr
 = 1;

60 
	`£tsockİt
Ğ
cÚnfd
, 
SOL_SOCKET
, 
SO_OOBINLINE
, &
nReu£Addr
, (‚ReuseAddr ) );

63 
	`mem£t
Ğ
buf
, '\0', ( buf ) );

64 
	`FD_SET
Ğ
cÚnfd
, &
»ad_fds
 );

65 
	`FD_SET
Ğ
cÚnfd
, &
exû±iÚ_fds
 );

67 
»t
 = 
	`£Ëù
Ğ
cÚnfd
 + 1, &
»ad_fds
, 
NULL
, &
exû±iÚ_fds
, NULL );

68 
	`´štf
( "select one\n" );

69 iàĞ
»t
 < 0 )

71 
	`´štf
( "selection failure\n" );

75 iàĞ
	`FD_ISSET
Ğ
cÚnfd
, &
»ad_fds
 ) )

77 
»t
 = 
	`»cv
Ğ
cÚnfd
, 
buf
, ( buf )-1, 0 );

78 ifĞ
»t
 <= 0 )

82 
	`´štf
Ğ"g‘ %d by‹ oànÜm® d©a: %s\n", 
»t
, 
buf
 );

84 ifĞ
	`FD_ISSET
Ğ
cÚnfd
, &
exû±iÚ_fds
 ) )

86 
»t
 = 
	`»cv
Ğ
cÚnfd
, 
buf
, Ğbuà)-1, 
MSG_OOB
 );

87 ifĞ
»t
 <= 0 )

91 
	`´štf
Ğ"g‘ %d by‹ oàoob d©a: %s\n", 
»t
, 
buf
 );

96 
	`şo£
Ğ
cÚnfd
 );

97 
	`şo£
Ğ
li¡’fd
 );

99 
	}
}

	@9-3mtlt.cpp

1 
	~<sys/ty³s.h
>

2 
	~<sys/sock‘.h
>

3 
	~<Ãtš‘/š.h
>

4 
	~<¬·/š‘.h
>

5 
	~<as£¹.h
>

6 
	~<¡dio.h
>

7 
	~<uni¡d.h
>

8 
	~<”ºo.h
>

9 
	~<¡ršg.h
>

10 
	~<fú.h
>

11 
	~<¡dlib.h
>

12 
	~<sys/•Şl.h
>

13 
	~<±h»ad.h
>

15 
	#MAX_EVENT_NUMBER
 1024

	)

16 
	#BUFFER_SIZE
 10

	)

18 
	$£ŠÚblockšg
Ğ
fd
 )

20 
Şd_İtiÚ
 = 
	`fú
Ğ
fd
, 
F_GETFL
 );

21 
Ãw_İtiÚ
 = 
Şd_İtiÚ
 | 
O_NONBLOCK
;

22 
	`fú
Ğ
fd
, 
F_SETFL
, 
Ãw_İtiÚ
 );

23  
Şd_İtiÚ
;

24 
	}
}

26 
	$addfd
Ğ
•Şlfd
, 
fd
, 
boŞ
 
’abË_‘
 )

28 
•Şl_ev’t
 
ev’t
;

29 
ev’t
.
d©a
.
fd
 = fd;

30 
ev’t
.
ev’ts
 = 
EPOLLIN
;

31 ifĞ
’abË_‘
 )

33 
ev’t
.
ev’ts
 |ğ
EPOLLET
;

35 
	`•Şl_ùl
Ğ
•Şlfd
, 
EPOLL_CTL_ADD
, 
fd
, &
ev’t
 );

36 
	`£ŠÚblockšg
Ğ
fd
 );

37 
	}
}

39 
	$É
Ğ
•Şl_ev’t
* 
ev’ts
, 
numb”
, 
•Şlfd
, 
li¡’fd
 )

41 
buf
[ 
BUFFER_SIZE
 ];

42  
i
 = 0; i < 
numb”
; i++ )

44 
sockfd
 = 
ev’ts
[
i
].
d©a
.
fd
;

45 iàĞ
sockfd
 =ğ
li¡’fd
 )

47 
sockaddr_š
 
ş›Á_add»ss
;

48 
sockËn_t
 
ş›Á_add¾’gth
 = Ğ
ş›Á_add»ss
 );

49 
cÚnfd
 = 
	`acû±
Ğ
li¡’fd
, ( 
sockaddr
* )&
ş›Á_add»ss
, &
ş›Á_add¾’gth
 );

50 
	`addfd
Ğ
•Şlfd
, 
cÚnfd
, 
çl£
 );

52 iàĞ
ev’ts
[
i
].ev’t & 
EPOLLIN
 )

54 
	`´štf
( "eventrigger once\n" );

55 
	`mem£t
Ğ
buf
, '\0', 
BUFFER_SIZE
 );

56 
»t
 = 
	`»cv
Ğ
sockfd
, 
buf
, 
BUFFER_SIZE
-1, 0 );

57 ifĞ
»t
 <= 0 )

59 
	`şo£
Ğ
sockfd
 );

62 
	`´štf
Ğ"g‘ %d by‹ oàcÚ‹Á: %s\n", 
»t
, 
buf
 );

66 
	`´štf
( "somethingƒlse happened \n" );

69 
	}
}

71 
	$‘
Ğ
•Şl_ev’t
* 
ev’ts
, 
numb”
, 
•Şlfd
, 
li¡’fd
 )

73 
buf
[ 
BUFFER_SIZE
 ];

74  
i
 = 0; i < 
numb”
; i++ )

76 
sockfd
 = 
ev’ts
[
i
].
d©a
.
fd
;

77 iàĞ
sockfd
 =ğ
li¡’fd
 )

79 
sockaddr_š
 
ş›Á_add»ss
;

80 
sockËn_t
 
ş›Á_add¾’gth
 = Ğ
ş›Á_add»ss
 );

81 
cÚnfd
 = 
	`acû±
Ğ
li¡’fd
, ( 
sockaddr
* )&
ş›Á_add»ss
, &
ş›Á_add¾’gth
 );

82 
	`addfd
Ğ
•Şlfd
, 
cÚnfd
, 
Œue
 );

84 iàĞ
ev’ts
[
i
].ev’t & 
EPOLLIN
 )

86 
	`´štf
( "eventrigger once\n" );

89 
	`mem£t
Ğ
buf
, '\0', 
BUFFER_SIZE
 );

90 
»t
 = 
	`»cv
Ğ
sockfd
, 
buf
, 
BUFFER_SIZE
-1, 0 );

91 ifĞ
»t
 < 0 )

93 ifĞĞ
”ºo
 =ğ
EAGAIN
 ) || (ƒ¼nØ=ğ
EWOULDBLOCK
 ) )

95 
	`´štf
( "read†ater\n" );

98 
	`şo£
Ğ
sockfd
 );

101 ifĞ
»t
 == 0 )

103 
	`şo£
Ğ
sockfd
 );

107 
	`´štf
Ğ"g‘ %d by‹ oàcÚ‹Á: %s\n", 
»t
, 
buf
 );

113 
	`´štf
( "somethingƒlse happened \n" );

116 
	}
}

118 
	$maš
Ğ
¬gc
, * 
¬gv
[] )

120 ifĞ
¬gc
 <= 2 )

122 
	`´štf
Ğ"u§ge: % _add»s pÜt_numb”\n", 
	`ba£Çme
Ğ
¬gv
[0] ) );

125 cÚ¡ * 

 = 
¬gv
[1];

126 
pÜt
 = 
	`©oi
Ğ
¬gv
[2] );

128 
»t
 = 0;

129 
sockaddr_š
 
add»ss
;

130 
	`bz”o
Ğ&
add»ss
, (‡ddress ) );

131 
add»ss
.
sš_çmy
 = 
AF_INET
;

132 
	`š‘_±Ú
Ğ
AF_INET
, 

, &
add»ss
.
sš_addr
 );

133 
add»ss
.
sš_pÜt
 = 
	`htÚs
Ğ
pÜt
 );

135 
li¡’fd
 = 
	`sock‘
Ğ
PF_INET
, 
SOCK_STREAM
, 0 );

136 
	`as£¹
Ğ
li¡’fd
 >= 0 );

138 
»t
 = 
	`bšd
Ğ
li¡’fd
, ( 
sockaddr
* )&
add»ss
, (‡ddress ) );

139 
	`as£¹
Ğ
»t
 != -1 );

141 
»t
 = 
	`li¡’
Ğ
li¡’fd
, 5 );

142 
	`as£¹
Ğ
»t
 != -1 );

144 
•Şl_ev’t
 
ev’ts
[ 
MAX_EVENT_NUMBER
 ];

145 
•Şlfd
 = 
	`•Şl_ü—‹
( 5 );

146 
	`as£¹
Ğ
•Şlfd
 != -1 );

147 
	`addfd
Ğ
•Şlfd
, 
li¡’fd
, 
Œue
 );

151 
»t
 = 
	`•Şl_wa™
Ğ
•Şlfd
, 
ev’ts
, 
MAX_EVENT_NUMBER
, -1 );

152 iàĞ
»t
 < 0 )

154 
	`´štf
( "epoll failure\n" );

158 
	`É
Ğ
ev’ts
, 
»t
, 
•Şlfd
, 
li¡’fd
 );

162 
	`şo£
Ğ
li¡’fd
 );

164 
	}
}

	@9-4oneshot.cpp

1 
	~<sys/ty³s.h
>

2 
	~<sys/sock‘.h
>

3 
	~<Ãtš‘/š.h
>

4 
	~<¬·/š‘.h
>

5 
	~<as£¹.h
>

6 
	~<¡dio.h
>

7 
	~<uni¡d.h
>

8 
	~<”ºo.h
>

9 
	~<¡ršg.h
>

10 
	~<fú.h
>

11 
	~<¡dlib.h
>

12 
	~<sys/•Şl.h
>

13 
	~<±h»ad.h
>

15 
	#MAX_EVENT_NUMBER
 1024

	)

16 
	#BUFFER_SIZE
 1024

	)

17 
	sfds


19 
	m•Şlfd
;

20 
	msockfd
;

23 
	$£ŠÚblockšg
Ğ
fd
 )

25 
Şd_İtiÚ
 = 
	`fú
Ğ
fd
, 
F_GETFL
 );

26 
Ãw_İtiÚ
 = 
Şd_İtiÚ
 | 
O_NONBLOCK
;

27 
	`fú
Ğ
fd
, 
F_SETFL
, 
Ãw_İtiÚ
 );

28  
Şd_İtiÚ
;

29 
	}
}

31 
	$addfd
Ğ
•Şlfd
, 
fd
, 
boŞ
 
ÚeshÙ
 )

33 
•Şl_ev’t
 
ev’t
;

34 
ev’t
.
d©a
.
fd
 = fd;

35 
ev’t
.
ev’ts
 = 
EPOLLIN
 | 
EPOLLET
;

36 ifĞ
ÚeshÙ
 )

38 
ev’t
.
ev’ts
 |ğ
EPOLLONESHOT
;

40 
	`•Şl_ùl
Ğ
•Şlfd
, 
EPOLL_CTL_ADD
, 
fd
, &
ev’t
 );

41 
	`£ŠÚblockšg
Ğ
fd
 );

42 
	}
}

44 
	$»£t_ÚeshÙ
Ğ
•Şlfd
, 
fd
 )

46 
•Şl_ev’t
 
ev’t
;

47 
ev’t
.
d©a
.
fd
 = fd;

48 
ev’t
.
ev’ts
 = 
EPOLLIN
 | 
EPOLLET
 | 
EPOLLONESHOT
;

49 
	`•Şl_ùl
Ğ
•Şlfd
, 
EPOLL_CTL_MOD
, 
fd
, &
ev’t
 );

50 
	}
}

52 * 
	$wÜk”
Ğ* 
¬g
 )

54 
sockfd
 = ( (
fds
*)
¬g
 )->sockfd;

55 
•Şlfd
 = ( (
fds
*)
¬g
 )->epollfd;

56 
	`´štf
Ğ"¡¬ˆÃwh»adØ»ûivd©¨Ú fd: %d\n", 
sockfd
 );

57 
buf
[ 
BUFFER_SIZE
 ];

58 
	`mem£t
Ğ
buf
, '\0', 
BUFFER_SIZE
 );

61 
»t
 = 
	`»cv
Ğ
sockfd
, 
buf
, 
BUFFER_SIZE
-1, 0 );

62 ifĞ
»t
 == 0 )

64 
	`şo£
Ğ
sockfd
 );

65 
	`´štf
( "foreiner closedhe connection\n" );

68 ifĞ
»t
 < 0 )

70 ifĞ
”ºo
 =ğ
EAGAIN
 )

72 
	`»£t_ÚeshÙ
Ğ
•Şlfd
, 
sockfd
 );

73 
	`´štf
( "read†ater\n" );

79 
	`´štf
Ğ"g‘ cÚ‹Á: %s\n", 
buf
 );

80 
	`¦“p
( 5 );

83 
	`´štf
Ğ"’dh»ad„eûivšg d©¨Ú fd: %d\n", 
sockfd
 );

84 
	}
}

86 
	$maš
Ğ
¬gc
, * 
¬gv
[] )

88 ifĞ
¬gc
 <= 2 )

90 
	`´štf
Ğ"u§ge: % _add»s pÜt_numb”\n", 
	`ba£Çme
Ğ
¬gv
[0] ) );

93 cÚ¡ * 

 = 
¬gv
[1];

94 
pÜt
 = 
	`©oi
Ğ
¬gv
[2] );

96 
»t
 = 0;

97 
sockaddr_š
 
add»ss
;

98 
	`bz”o
Ğ&
add»ss
, (‡ddress ) );

99 
add»ss
.
sš_çmy
 = 
AF_INET
;

100 
	`š‘_±Ú
Ğ
AF_INET
, 

, &
add»ss
.
sš_addr
 );

101 
add»ss
.
sš_pÜt
 = 
	`htÚs
Ğ
pÜt
 );

103 
li¡’fd
 = 
	`sock‘
Ğ
PF_INET
, 
SOCK_STREAM
, 0 );

104 
	`as£¹
Ğ
li¡’fd
 >= 0 );

106 
»t
 = 
	`bšd
Ğ
li¡’fd
, ( 
sockaddr
* )&
add»ss
, (‡ddress ) );

107 
	`as£¹
Ğ
»t
 != -1 );

109 
»t
 = 
	`li¡’
Ğ
li¡’fd
, 5 );

110 
	`as£¹
Ğ
»t
 != -1 );

112 
•Şl_ev’t
 
ev’ts
[ 
MAX_EVENT_NUMBER
 ];

113 
•Şlfd
 = 
	`•Şl_ü—‹
( 5 );

114 
	`as£¹
Ğ
•Şlfd
 != -1 );

115 
	`addfd
Ğ
•Şlfd
, 
li¡’fd
, 
çl£
 );

119 
»t
 = 
	`•Şl_wa™
Ğ
•Şlfd
, 
ev’ts
, 
MAX_EVENT_NUMBER
, -1 );

120 iàĞ
»t
 < 0 )

122 
	`´štf
( "epoll failure\n" );

126  
i
 = 0; i < 
»t
; i++ )

128 
sockfd
 = 
ev’ts
[
i
].
d©a
.
fd
;

129 iàĞ
sockfd
 =ğ
li¡’fd
 )

131 
sockaddr_š
 
ş›Á_add»ss
;

132 
sockËn_t
 
ş›Á_add¾’gth
 = Ğ
ş›Á_add»ss
 );

133 
cÚnfd
 = 
	`acû±
Ğ
li¡’fd
, ( 
sockaddr
* )&
ş›Á_add»ss
, &
ş›Á_add¾’gth
 );

134 
	`addfd
Ğ
•Şlfd
, 
cÚnfd
, 
Œue
 );

136 iàĞ
ev’ts
[
i
].ev’t & 
EPOLLIN
 )

138 
±h»ad_t
 
th»ad
;

139 
fds
 
fds_fÜ_Ãw_wÜk”
;

140 
fds_fÜ_Ãw_wÜk”
.
•Şlfd
 =ƒpollfd;

141 
fds_fÜ_Ãw_wÜk”
.
sockfd
 = sockfd;

142 
	`±h»ad_ü—‹
Ğ&
th»ad
, 
NULL
, 
wÜk”
, ( * )&
fds_fÜ_Ãw_wÜk”
 );

146 
	`´štf
( "somethingƒlse happened \n" );

151 
	`şo£
Ğ
li¡’fd
 );

153 
	}
}

	@9-5unblockconnect.cpp

1 
	~<sys/ty³s.h
>

2 
	~<sys/sock‘.h
>

3 
	~<Ãtš‘/š.h
>

4 
	~<¬·/š‘.h
>

5 
	~<¡dlib.h
>

6 
	~<as£¹.h
>

7 
	~<¡dio.h
>

8 
	~<time.h
>

9 
	~<”ºo.h
>

10 
	~<fú.h
>

11 
	~<sys/ioùl.h
>

12 
	~<uni¡d.h
>

13 
	~<¡ršg.h
>

15 
	#BUFFER_SIZE
 1023

	)

17 
	$£ŠÚblockšg
Ğ
fd
 )

19 
Şd_İtiÚ
 = 
	`fú
Ğ
fd
, 
F_GETFL
 );

20 
Ãw_İtiÚ
 = 
Şd_İtiÚ
 | 
O_NONBLOCK
;

21 
	`fú
Ğ
fd
, 
F_SETFL
, 
Ãw_İtiÚ
 );

22  
Şd_İtiÚ
;

23 
	}
}

25 
	$unblock_cÚÃù
ĞcÚ¡ * 

, 
pÜt
, 
time
 )

27 
»t
 = 0;

28 
sockaddr_š
 
add»ss
;

29 
	`bz”o
Ğ&
add»ss
, (‡ddress ) );

30 
add»ss
.
sš_çmy
 = 
AF_INET
;

31 
	`š‘_±Ú
Ğ
AF_INET
, 

, &
add»ss
.
sš_addr
 );

32 
add»ss
.
sš_pÜt
 = 
	`htÚs
Ğ
pÜt
 );

34 
sockfd
 = 
	`sock‘
Ğ
PF_INET
, 
SOCK_STREAM
, 0 );

35 
fdİt
 = 
	`£ŠÚblockšg
Ğ
sockfd
 );

36 
»t
 = 
	`cÚÃù
Ğ
sockfd
, ( 
sockaddr
* )&
add»ss
, (‡ddress ) );

37 iàĞ
»t
 == 0 )

39 
	`´štf
( "connect with server immediately\n" );

40 
	`fú
Ğ
sockfd
, 
F_SETFL
, 
fdİt
 );

41  
sockfd
;

43 iàĞ
”ºo
 !ğ
EINPROGRESS
 )

45 
	`´štf
( "unblock connect‚ot support\n" );

49 
fd_£t
 
»adfds
;

50 
fd_£t
 
wr™efds
;

51 
timev®
 
timeout
;

53 
	`FD_ZERO
Ğ&
»adfds
 );

54 
	`FD_SET
Ğ
sockfd
, &
wr™efds
 );

56 
timeout
.
tv_£c
 = 
time
;

57 
timeout
.
tv_u£c
 = 0;

59 
»t
 = 
	`£Ëù
Ğ
sockfd
 + 1, 
NULL
, &
wr™efds
, NULL, &
timeout
 );

60 iàĞ
»t
 <= 0 )

62 
	`´štf
( "connectionime out\n" );

63 
	`şo£
Ğ
sockfd
 );

67 iàĞ! 
	`FD_ISSET
Ğ
sockfd
, &
wr™efds
 ) )

69 
	`´štf
( "noƒvents on sockfd found\n" );

70 
	`şo£
Ğ
sockfd
 );

74 
”rÜ
 = 0;

75 
sockËn_t
 
Ëngth
 = Ğ
”rÜ
 );

76 ifĞ
	`g‘sockİt
Ğ
sockfd
, 
SOL_SOCKET
, 
SO_ERROR
, &
”rÜ
, &
Ëngth
 ) < 0 )

78 
	`´štf
( "get socket option failed\n" );

79 
	`şo£
Ğ
sockfd
 );

83 ifĞ
”rÜ
 != 0 )

85 
	`´štf
Ğ"cÚÃùiÚ faed‡á” s–eù w™hh”rÜ: %d \n", 
”rÜ
 );

86 
	`şo£
Ğ
sockfd
 );

90 
	`´štf
Ğ"cÚÃùiÚ„—dy‡á” s–eù w™hhsock‘: %d \n", 
sockfd
 );

91 
	`fú
Ğ
sockfd
, 
F_SETFL
, 
fdİt
 );

92  
sockfd
;

93 
	}
}

95 
	$maš
Ğ
¬gc
, * 
¬gv
[] )

97 ifĞ
¬gc
 <= 2 )

99 
	`´štf
Ğ"u§ge: % _add»s pÜt_numb”\n", 
	`ba£Çme
Ğ
¬gv
[0] ) );

102 cÚ¡ * 

 = 
¬gv
[1];

103 
pÜt
 = 
	`©oi
Ğ
¬gv
[2] );

105 
sockfd
 = 
	`unblock_cÚÃù
Ğ

, 
pÜt
, 10 );

106 iàĞ
sockfd
 < 0 )

110 
	`shutdown
Ğ
sockfd
, 
SHUT_WR
 );

111 
	`¦“p
( 200 );

112 
	`´štf
( "send data out\n" );

113 
	`£nd
Ğ
sockfd
, "abc", 3, 0 );

116 
	}
}

	@9-6mytalk_client.cpp

1 
	#_GNU_SOURCE
 1

	)

2 
	~<sys/ty³s.h
>

3 
	~<sys/sock‘.h
>

4 
	~<Ãtš‘/š.h
>

5 
	~<¬·/š‘.h
>

6 
	~<as£¹.h
>

7 
	~<¡dio.h
>

8 
	~<uni¡d.h
>

9 
	~<¡ršg.h
>

10 
	~<¡dlib.h
>

11 
	~<pŞl.h
>

12 
	~<fú.h
>

14 
	#BUFFER_SIZE
 64

	)

16 
	$maš
Ğ
¬gc
, * 
¬gv
[] )

18 ifĞ
¬gc
 <= 2 )

20 
	`´štf
Ğ"u§ge: % _add»s pÜt_numb”\n", 
	`ba£Çme
Ğ
¬gv
[0] ) );

23 cÚ¡ * 

 = 
¬gv
[1];

24 
pÜt
 = 
	`©oi
Ğ
¬gv
[2] );

26 
sockaddr_š
 
£rv”_add»ss
;

27 
	`bz”o
Ğ&
£rv”_add»ss
, ( server_address ) );

28 
£rv”_add»ss
.
sš_çmy
 = 
AF_INET
;

29 
	`š‘_±Ú
Ğ
AF_INET
, 

, &
£rv”_add»ss
.
sš_addr
 );

30 
£rv”_add»ss
.
sš_pÜt
 = 
	`htÚs
Ğ
pÜt
 );

32 
sockfd
 = 
	`sock‘
Ğ
PF_INET
, 
SOCK_STREAM
, 0 );

33 
	`as£¹
Ğ
sockfd
 >= 0 );

34 iàĞ
	`cÚÃù
Ğ
sockfd
, ( 
sockaddr
* )&
£rv”_add»ss
, ( server_address ) ) < 0 )

36 
	`´štf
( "connection failed\n" );

37 
	`şo£
Ğ
sockfd
 );

41 
pŞlfd
 
fds
[2];

42 
fds
[0].
fd
 = 0;

43 
fds
[0].
ev’ts
 = 
POLLIN
;

44 
fds
[0].
»v’ts
 = 0;

45 
fds
[1].
fd
 = 
sockfd
;

46 
fds
[1].
ev’ts
 = 
POLLIN
 | 
POLLRDHUP
;

47 
fds
[1].
»v’ts
 = 0;

48 
»ad_buf
[
BUFFER_SIZE
];

49 
pefd
[2];

50 
»t
 = 
	`pe
Ğ
pefd
 );

51 
	`as£¹
Ğ
»t
 != -1 );

55 
»t
 = 
	`pŞl
Ğ
fds
, 2, -1 );

56 ifĞ
»t
 < 0 )

58 
	`´štf
( "poll failure\n" );

62 ifĞ
fds
[1].
»v’ts
 & 
POLLRDHUP
 )

64 
	`´štf
( "server closehe connection\n" );

67 ifĞ
fds
[1].
»v’ts
 & 
POLLIN
 )

69 
	`mem£t
Ğ
»ad_buf
, '\0', 
BUFFER_SIZE
 );

70 
	`»cv
Ğ
fds
[1].
fd
, 
»ad_buf
, 
BUFFER_SIZE
-1, 0 );

71 
	`´štf
Ğ"%s\n", 
»ad_buf
 );

74 ifĞ
fds
[0].
»v’ts
 & 
POLLIN
 )

76 
»t
 = 
	`¥liû
Ğ0, 
NULL
, 
pefd
[1], NULL, 32768, 
SPLICE_F_MORE
 | 
SPLICE_F_MOVE
 );

77 
»t
 = 
	`¥liû
Ğ
pefd
[0], 
NULL
, 
sockfd
, NULL, 32768, 
SPLICE_F_MORE
 | 
SPLICE_F_MOVE
 );

81 
	`şo£
Ğ
sockfd
 );

83 
	}
}

	@9-7mytalk_server.cpp

1 
	#_GNU_SOURCE
 1

	)

2 
	~<sys/ty³s.h
>

3 
	~<sys/sock‘.h
>

4 
	~<Ãtš‘/š.h
>

5 
	~<¬·/š‘.h
>

6 
	~<as£¹.h
>

7 
	~<¡dio.h
>

8 
	~<uni¡d.h
>

9 
	~<”ºo.h
>

10 
	~<¡ršg.h
>

11 
	~<fú.h
>

12 
	~<¡dlib.h
>

13 
	~<pŞl.h
>

15 
	#USER_LIMIT
 5

	)

16 
	#BUFFER_SIZE
 64

	)

17 
	#FD_LIMIT
 65535

	)

19 
	sş›Á_d©a


21 
sockaddr_š
 
	madd»ss
;

22 * 
	mwr™e_buf
;

23 
	mbuf
[ 
BUFFER_SIZE
 ];

26 
	$£ŠÚblockšg
Ğ
fd
 )

28 
Şd_İtiÚ
 = 
	`fú
Ğ
fd
, 
F_GETFL
 );

29 
Ãw_İtiÚ
 = 
Şd_İtiÚ
 | 
O_NONBLOCK
;

30 
	`fú
Ğ
fd
, 
F_SETFL
, 
Ãw_İtiÚ
 );

31  
Şd_İtiÚ
;

32 
	}
}

34 
	$maš
Ğ
¬gc
, * 
¬gv
[] )

36 ifĞ
¬gc
 <= 2 )

38 
	`´štf
Ğ"u§ge: % _add»s pÜt_numb”\n", 
	`ba£Çme
Ğ
¬gv
[0] ) );

41 cÚ¡ * 

 = 
¬gv
[1];

42 
pÜt
 = 
	`©oi
Ğ
¬gv
[2] );

44 
»t
 = 0;

45 
sockaddr_š
 
add»ss
;

46 
	`bz”o
Ğ&
add»ss
, (‡ddress ) );

47 
add»ss
.
sš_çmy
 = 
AF_INET
;

48 
	`š‘_±Ú
Ğ
AF_INET
, 

, &
add»ss
.
sš_addr
 );

49 
add»ss
.
sš_pÜt
 = 
	`htÚs
Ğ
pÜt
 );

51 
li¡’fd
 = 
	`sock‘
Ğ
PF_INET
, 
SOCK_STREAM
, 0 );

52 
	`as£¹
Ğ
li¡’fd
 >= 0 );

54 
»t
 = 
	`bšd
Ğ
li¡’fd
, ( 
sockaddr
* )&
add»ss
, (‡ddress ) );

55 
	`as£¹
Ğ
»t
 != -1 );

57 
»t
 = 
	`li¡’
Ğ
li¡’fd
, 5 );

58 
	`as£¹
Ğ
»t
 != -1 );

60 
ş›Á_d©a
* 
u£rs
 = 
Ãw
 cl›Á_d©a[
FD_LIMIT
];

61 
pŞlfd
 
fds
[
USER_LIMIT
+1];

62 
u£r_couÁ”
 = 0;

63  
i
 = 1; i <ğ
USER_LIMIT
; ++i )

65 
fds
[
i
].
fd
 = -1;

66 
fds
[
i
].
ev’ts
 = 0;

68 
fds
[0].
fd
 = 
li¡’fd
;

69 
fds
[0].
ev’ts
 = 
POLLIN
 | 
POLLERR
;

70 
fds
[0].
»v’ts
 = 0;

74 
»t
 = 
	`pŞl
Ğ
fds
, 
u£r_couÁ”
+1, -1 );

75 iàĞ
»t
 < 0 )

77 
	`´štf
( "poll failure\n" );

81  
i
 = 0; i < 
u£r_couÁ”
+1; ++i )

83 ifĞĞ
fds
[
i
].
fd
 =ğ
li¡’fd
 ) && ( fds[i].
»v’ts
 & 
POLLIN
 ) )

85 
sockaddr_š
 
ş›Á_add»ss
;

86 
sockËn_t
 
ş›Á_add¾’gth
 = Ğ
ş›Á_add»ss
 );

87 
cÚnfd
 = 
	`acû±
Ğ
li¡’fd
, ( 
sockaddr
* )&
ş›Á_add»ss
, &
ş›Á_add¾’gth
 );

88 iàĞ
cÚnfd
 < 0 )

90 
	`´štf
Ğ"”ºØis: %d\n", 
”ºo
 );

93 ifĞ
u£r_couÁ”
 >ğ
USER_LIMIT
 )

95 cÚ¡ * 
šfo
 = "too many users\n";

96 
	`´štf
Ğ"%s", 
šfo
 );

97 
	`£nd
Ğ
cÚnfd
, 
šfo
, 
	`¡¾’
( info ), 0 );

98 
	`şo£
Ğ
cÚnfd
 );

101 
u£r_couÁ”
++;

102 
u£rs
[
cÚnfd
].
add»ss
 = 
ş›Á_add»ss
;

103 
	`£ŠÚblockšg
Ğ
cÚnfd
 );

104 
fds
[
u£r_couÁ”
].
fd
 = 
cÚnfd
;

105 
fds
[
u£r_couÁ”
].
ev’ts
 = 
POLLIN
 | 
POLLRDHUP
 | 
POLLERR
;

106 
fds
[
u£r_couÁ”
].
»v’ts
 = 0;

107 
	`´štf
Ğ"come ¨Ãw u£r,‚ow hav%d u£rs\n", 
u£r_couÁ”
 );

109 ifĞ
fds
[
i
].
»v’ts
 & 
POLLERR
 )

111 
	`´štf
Ğ"g‘‡À”rÜ from %d\n", 
fds
[
i
].
fd
 );

112 
”rÜs
[ 100 ];

113 
	`mem£t
Ğ
”rÜs
, '\0', 100 );

114 
sockËn_t
 
Ëngth
 = Ğ
”rÜs
 );

115 ifĞ
	`g‘sockİt
Ğ
fds
[
i
].
fd
, 
SOL_SOCKET
, 
SO_ERROR
, &
”rÜs
, &
Ëngth
 ) < 0 )

117 
	`´štf
( "get socket option failed\n" );

121 ifĞ
fds
[
i
].
»v’ts
 & 
POLLRDHUP
 )

123 
u£rs
[
fds
[
i
].
fd
] = u£rs[fds[
u£r_couÁ”
].fd];

124 
	`şo£
Ğ
fds
[
i
].
fd
 );

125 
fds
[
i
] = fds[
u£r_couÁ”
];

126 
i
--;

127 
u£r_couÁ”
--;

128 
	`´štf
( "a client†eft\n" );

130 ifĞ
fds
[
i
].
»v’ts
 & 
POLLIN
 )

132 
cÚnfd
 = 
fds
[
i
].
fd
;

133 
	`mem£t
Ğ
u£rs
[
cÚnfd
].
buf
, '\0', 
BUFFER_SIZE
 );

134 
»t
 = 
	`»cv
Ğ
cÚnfd
, 
u£rs
[cÚnfd].
buf
, 
BUFFER_SIZE
-1, 0 );

135 
	`´štf
Ğ"g‘ %d by‹ oàş›Á d©¨% äom %d\n", 
»t
, 
u£rs
[
cÚnfd
].
buf
, connfd );

136 ifĞ
»t
 < 0 )

138 ifĞ
”ºo
 !ğ
EAGAIN
 )

140 
	`şo£
Ğ
cÚnfd
 );

141 
u£rs
[
fds
[
i
].
fd
] = u£rs[fds[
u£r_couÁ”
].fd];

142 
fds
[
i
] = fds[
u£r_couÁ”
];

143 
i
--;

144 
u£r_couÁ”
--;

147 ifĞ
»t
 == 0 )

149 
	`´štf
( "code should‚ot comeo here\n" );

153  
j
 = 1; j <ğ
u£r_couÁ”
; ++j )

155 ifĞ
fds
[
j
].
fd
 =ğ
cÚnfd
 )

160 
fds
[
j
].
ev’ts
 |ğ~
POLLIN
;

161 
fds
[
j
].
ev’ts
 |ğ
POLLOUT
;

162 
u£rs
[
fds
[
j
].
fd
].
wr™e_buf
 = u£rs[
cÚnfd
].
buf
;

166 ifĞ
fds
[
i
].
»v’ts
 & 
POLLOUT
 )

168 
cÚnfd
 = 
fds
[
i
].
fd
;

169 ifĞ! 
u£rs
[
cÚnfd
].
wr™e_buf
 )

173 
»t
 = 
	`£nd
Ğ
cÚnfd
, 
u£rs
[cÚnfd].
wr™e_buf
, 
	`¡¾’
( users[connfd].write_buf ), 0 );

174 
u£rs
[
cÚnfd
].
wr™e_buf
 = 
NULL
;

175 
fds
[
i
].
ev’ts
 |ğ~
POLLOUT
;

176 
fds
[
i
].
ev’ts
 |ğ
POLLIN
;

181 
d–‘e
 [] 
u£rs
;

182 
	`şo£
Ğ
li¡’fd
 );

184 
	}
}

	@9-8multi_port.cpp

1 
	~<sys/ty³s.h
>

2 
	~<sys/sock‘.h
>

3 
	~<Ãtš‘/š.h
>

4 
	~<¬·/š‘.h
>

5 
	~<as£¹.h
>

6 
	~<¡dio.h
>

7 
	~<uni¡d.h
>

8 
	~<”ºo.h
>

9 
	~<¡ršg.h
>

10 
	~<fú.h
>

11 
	~<¡dlib.h
>

12 
	~<sys/•Şl.h
>

13 
	~<±h»ad.h
>

15 
	#MAX_EVENT_NUMBER
 1024

	)

16 
	#TCP_BUFFER_SIZE
 512

	)

17 
	#UDP_BUFFER_SIZE
 1024

	)

19 
	$£ŠÚblockšg
Ğ
fd
 )

21 
Şd_İtiÚ
 = 
	`fú
Ğ
fd
, 
F_GETFL
 );

22 
Ãw_İtiÚ
 = 
Şd_İtiÚ
 | 
O_NONBLOCK
;

23 
	`fú
Ğ
fd
, 
F_SETFL
, 
Ãw_İtiÚ
 );

24  
Şd_İtiÚ
;

25 
	}
}

27 
	$addfd
Ğ
•Şlfd
, 
fd
 )

29 
•Şl_ev’t
 
ev’t
;

30 
ev’t
.
d©a
.
fd
 = fd;

32 
ev’t
.
ev’ts
 = 
EPOLLIN
;

33 
	`•Şl_ùl
Ğ
•Şlfd
, 
EPOLL_CTL_ADD
, 
fd
, &
ev’t
 );

34 
	`£ŠÚblockšg
Ğ
fd
 );

35 
	}
}

37 
	$maš
Ğ
¬gc
, * 
¬gv
[] )

39 ifĞ
¬gc
 <= 2 )

41 
	`´štf
Ğ"u§ge: % _add»s pÜt_numb”\n", 
	`ba£Çme
Ğ
¬gv
[0] ) );

44 cÚ¡ * 

 = 
¬gv
[1];

45 
pÜt
 = 
	`©oi
Ğ
¬gv
[2] );

47 
»t
 = 0;

48 
sockaddr_š
 
add»ss
;

49 
	`bz”o
Ğ&
add»ss
, (‡ddress ) );

50 
add»ss
.
sš_çmy
 = 
AF_INET
;

51 
	`š‘_±Ú
Ğ
AF_INET
, 

, &
add»ss
.
sš_addr
 );

52 
add»ss
.
sš_pÜt
 = 
	`htÚs
Ğ
pÜt
 );

54 
li¡’fd
 = 
	`sock‘
Ğ
PF_INET
, 
SOCK_STREAM
, 0 );

55 
	`as£¹
Ğ
li¡’fd
 >= 0 );

57 
»t
 = 
	`bšd
Ğ
li¡’fd
, ( 
sockaddr
* )&
add»ss
, (‡ddress ) );

58 
	`as£¹
Ğ
»t
 != -1 );

60 
»t
 = 
	`li¡’
Ğ
li¡’fd
, 5 );

61 
	`as£¹
Ğ
»t
 != -1 );

63 
	`bz”o
Ğ&
add»ss
, (‡ddress ) );

64 
add»ss
.
sš_çmy
 = 
AF_INET
;

65 
	`š‘_±Ú
Ğ
AF_INET
, 

, &
add»ss
.
sš_addr
 );

66 
add»ss
.
sš_pÜt
 = 
	`htÚs
Ğ
pÜt
 );

67 
udpfd
 = 
	`sock‘
Ğ
PF_INET
, 
SOCK_DGRAM
, 0 );

68 
	`as£¹
Ğ
udpfd
 >= 0 );

70 
»t
 = 
	`bšd
Ğ
udpfd
, ( 
sockaddr
* )&
add»ss
, (‡ddress ) );

71 
	`as£¹
Ğ
»t
 != -1 );

73 
•Şl_ev’t
 
ev’ts
[ 
MAX_EVENT_NUMBER
 ];

74 
•Şlfd
 = 
	`•Şl_ü—‹
( 5 );

75 
	`as£¹
Ğ
•Şlfd
 != -1 );

76 
	`addfd
Ğ
•Şlfd
, 
li¡’fd
 );

77 
	`addfd
Ğ
•Şlfd
, 
udpfd
 );

81 
numb”
 = 
	`•Şl_wa™
Ğ
•Şlfd
, 
ev’ts
, 
MAX_EVENT_NUMBER
, -1 );

82 iàĞ
numb”
 < 0 )

84 
	`´štf
( "epoll failure\n" );

88  
i
 = 0; i < 
numb”
; i++ )

90 
sockfd
 = 
ev’ts
[
i
].
d©a
.
fd
;

91 iàĞ
sockfd
 =ğ
li¡’fd
 )

93 
sockaddr_š
 
ş›Á_add»ss
;

94 
sockËn_t
 
ş›Á_add¾’gth
 = Ğ
ş›Á_add»ss
 );

95 
cÚnfd
 = 
	`acû±
Ğ
li¡’fd
, ( 
sockaddr
* )&
ş›Á_add»ss
, &
ş›Á_add¾’gth
 );

96 
	`addfd
Ğ
•Şlfd
, 
cÚnfd
 );

98 iàĞ
sockfd
 =ğ
udpfd
 )

100 
buf
[ 
UDP_BUFFER_SIZE
 ];

101 
	`mem£t
Ğ
buf
, '\0', 
UDP_BUFFER_SIZE
 );

102 
sockaddr_š
 
ş›Á_add»ss
;

103 
sockËn_t
 
ş›Á_add¾’gth
 = Ğ
ş›Á_add»ss
 );

105 
»t
 = 
	`»cväom
Ğ
udpfd
, 
buf
, 
UDP_BUFFER_SIZE
-1, 0, ( 
sockaddr
* )&
ş›Á_add»ss
, &
ş›Á_add¾’gth
 );

106 ifĞ
»t
 > 0 )

108 
	`£ndto
Ğ
udpfd
, 
buf
, 
UDP_BUFFER_SIZE
-1, 0, ( 
sockaddr
* )&
ş›Á_add»ss
, 
ş›Á_add¾’gth
 );

111 iàĞ
ev’ts
[
i
].ev’t & 
EPOLLIN
 )

113 
buf
[ 
TCP_BUFFER_SIZE
 ];

116 
	`mem£t
Ğ
buf
, '\0', 
TCP_BUFFER_SIZE
 );

117 
»t
 = 
	`»cv
Ğ
sockfd
, 
buf
, 
TCP_BUFFER_SIZE
-1, 0 );

118 ifĞ
»t
 < 0 )

120 ifĞĞ
”ºo
 =ğ
EAGAIN
 ) || (ƒ¼nØ=ğ
EWOULDBLOCK
 ) )

124 
	`şo£
Ğ
sockfd
 );

127 ifĞ
»t
 == 0 )

129 
	`şo£
Ğ
sockfd
 );

133 
	`£nd
Ğ
sockfd
, 
buf
, 
»t
, 0 );

139 
	`´štf
( "somethingƒlse happened \n" );

144 
	`şo£
Ğ
li¡’fd
 );

146 
	}
}

	@
1
.
0
7
127
9-1use_select.cpp
9-3mtlt.cpp
9-4oneshot.cpp
9-5unblockconnect.cpp
9-6mytalk_client.cpp
9-7mytalk_server.cpp
9-8multi_port.cpp
